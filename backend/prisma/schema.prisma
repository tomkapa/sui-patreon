// Prisma schema for Sui Patreon platform
// Database: PostgreSQL 15+
// ORM: Prisma 6.19.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Creator model - Represents content creators on the platform
model Creator {
  id            String   @id @default(uuid()) @db.Uuid
  address       String   @unique // Sui wallet address
  profileId     String   @unique // Sui object ID for on-chain profile
  name          String   @unique // Unique creator name (e.g., SuiNS name)
  bio           String   @default("")
  avatarUrl     String? // Optional avatar image URL
  coverImageUrl String? // Optional cover/banner image URL
  category      String   @default("Creator") // Creator category (e.g., "Podcasts & shows", "Music")
  isVerified    Boolean  @default(false) // Verified creator badge
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Indexes for performance
  @@index([address])
  @@index([name])
  @@index([category])
  @@index([createdAt])
}

// Tier model - Subscription tiers offered by creators
model Tier {
  id          String   @id @default(uuid()) @db.Uuid
  tierId      String   @unique // Sui object ID for on-chain tier
  creatorId   String   @db.Uuid // Reference to Creator.id (no foreign key)
  name        String // Tier name (e.g., "Basic", "Premium")
  description String   @default("")
  price       BigInt // Price in MIST (1 SUI = 1,000,000,000 MIST)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Indexes for performance
  @@index([creatorId])
  @@index([tierId])
}

// Subscription model - Active subscriptions from subscribers to tiers
model Subscription {
  id             String   @id @default(uuid()) @db.Uuid
  subscriptionId String   @unique // Sui object ID for on-chain subscription
  subscriber     String // Sui wallet address of subscriber
  tierId         String   @db.Uuid // Reference to Tier.id (no foreign key)
  startsAt       DateTime // Subscription start timestamp
  expiresAt      DateTime // Subscription expiration timestamp
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  // Indexes for performance
  @@index([subscriber])
  @@index([subscriptionId])
  @@index([tierId])
}

// Content model - Content pieces created by creators
model Content {
  id            String    @id @default(uuid()) @db.Uuid
  contentId     String    @unique // Sui object ID for on-chain content
  creatorId     String    @db.Uuid // Reference to Creator.id (no foreign key)
  title         String
  description   String    @default("")
  contentType   String // MIME type (e.g., "video/mp4", "image/png", "text/markdown")
  walrusBlobId  String // Walrus blob ID for encrypted content
  previewBlobId String? // Optional Walrus blob ID for public preview
  isPublic      Boolean   @default(false) // If true, accessible without subscription
  isDraft       Boolean   @default(false) // If true, content is unpublished draft
  publishedAt   DateTime? // Publication timestamp (null if draft)
  viewCount     Int       @default(0) // Number of views
  likeCount     Int       @default(0) // Number of likes
  createdAt     DateTime  @default(now())

  // Indexes for performance
  @@index([creatorId])
  @@index([contentId])
  @@index([isDraft])
}

// ContentTier junction table - Many-to-many relationship between Content and Tier
model ContentTier {
  contentId String @db.Uuid // Reference to Content.id (no foreign key)
  tierId    String @db.Uuid // Reference to Tier.id (no foreign key)

  // Composite primary key
  @@id([contentId, tierId])
  @@index([contentId])
  @@index([tierId])
}

// Cursor model - Tracks event processing progress for resumable indexing (matches example pattern)
model Cursor {
  id       String @id // Event type identifier (e.g., "ProfileCreated", "TierCreated")
  eventSeq String // Last processed event sequence number
  txDigest String // Last processed transaction digest
}

// Visit model - Tracks user visits to creator profiles
model Visit {
  id          String   @id @default(uuid()) @db.Uuid
  userAddress String // Visitor's wallet address (or session ID for non-logged in)
  creatorId   String   @db.Uuid // Reference to Creator.id (no foreign key)
  visitedAt   DateTime @default(now())

  // Indexes for performance
  @@index([userAddress])
  @@index([creatorId])
  @@index([userAddress, visitedAt])
  @@index([userAddress, creatorId])
}

// Notification model - Alerts for subscribers and creators
model Notification {
  id          String   @id @default(uuid()) @db.Uuid

  // Who receives this notification
  recipientId String   @db.Uuid // Creator database ID

  // Notification details
  type        String // "NEW_CONTENT" | "NEW_SUBSCRIBER"
  title       String
  message     String

  // Related entities
  actorId     String? // Who triggered this (subscriber address or creator address)
  actorName   String? // Display name of actor
  contentId   String? // For NEW_CONTENT notifications

  // Metadata
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Indexes for performance
  @@index([recipientId])
  @@index([recipientId, isRead])
  @@index([createdAt])
}
